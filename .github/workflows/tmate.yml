# .github/workflows/create-vps.yml
name: Create and Renew VPS with Discord Notification

on:
  workflow_dispatch: # Manual "Run workflow" button
  schedule:
    # Har 6 ghante mein automatically run hoga
    - cron: '0 */6 * * *'

jobs:
  start-vps:
    runs-on: ubuntu-latest
    # Timeout ko 6 ghante se thoda kam rakhein taaki cleanup step chal sake
    timeout-minutes: 355 

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è System dependencies install karna
        run: |
          sudo apt-get update
          sudo apt-get install -y tmate sshpass jq

      - name: üöÄ tmate session shuru karna
        id: tmate # Step ko ek ID de rahe hain taaki output use kar sakein
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          
          # SSH connection string ko GITHUB_OUTPUT mein save karna
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "ssh_connection=${TMATE_SSH}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ SSH Session taiyar hai!"
          echo "$TMATE_SSH"

      - name: üí¨ Discord par DM bhejna
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_USER_ID: ${{ secrets.DISCORD_USER_ID }}
          SSH_CONNECTION: ${{ steps.tmate.outputs.ssh_connection }}
        run: |
          # Agar secrets set nahi hain to step skip karein
          if [ -z "$DISCORD_BOT_TOKEN" ] || [ -z "$DISCORD_USER_ID" ]; then
            echo "‚ö†Ô∏è Discord secrets set nahi hain. DM nahi bhej sakte."
            exit 0
          fi

          echo "DM channel banaya ja raha hai..."
          # Pehle user ke saath ek DM channel create karein
          CHANNEL_DATA=$(curl -s -X POST \
            -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"recipient_id\":\"$DISCORD_USER_ID\"}" \
            https://discord.com/api/v10/users/@me/channels)
          
          # Response se channel ID nikalein
          CHANNEL_ID=$(echo "$CHANNEL_DATA" | jq -r '.id')

          if [ -z "$CHANNEL_ID" ] || [ "$CHANNEL_ID" == "null" ]; then
              echo "‚ùå Discord DM channel banane mein fail hua. Response:"
              echo "$CHANNEL_DATA"
              exit 1
          fi
          
          echo "‚úÖ DM Channel ID: $CHANNEL_ID"
          echo "Naya SSH link DM kiya ja raha hai..."

          # Ab uss channel par message bhejein
          curl -s -X POST \
            -H "Authorization: Bot $DISCORD_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"üöÄ Aapka naya VPS taiyar hai!\\n\\nSSH Connection Link:\\n\`\`\`${SSH_CONNECTION}\`\`\`\"}" \
            https://discord.com/api/v10/channels/$CHANNEL_ID/messages
            
          echo "‚úÖ DM ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï bhej diya gaya."

      - name: ‚è≥ Session ko zinda rakhna
        run: |
          echo "‚è≥ Session ko lagbhag 6 ghante tak zinda rakha jayega..."
          # Loop chala kar session ko zinda rakhein
          end=$((SECONDS+19800)) # 5.5 ghante
          while [ $SECONDS -lt $end ]; do
            sleep 60
            # Check karein ki tmate session abhi bhi chal raha hai ya nahi
            if ! tmate -S /tmp/tmate.sock has-session; then
              echo "Tmate session band ho gaya."
              break
            fi
          done
          echo "Session ka samay samapt hua."

